<!--<p style="padding-left:30px;">择货员工号：<input type="text" id="user-id-text" class="panel-input-o" value="<%= current_user.id %>" /></p>-->
<!--<div id="filters">-->
<!--</div>-->
<div class='panel-header'>
  <p>需求面板</p>

  <div class="choose-employee">
    <label>当前使用员工:</label>
    <input type='text' id="user-id-text" value="<%= current_user.id %>"/>
    <a class='btn btn-xs btn-primary' id="change-user-id">更改</a>
  </div>
  <a class='btn btn-warning btn-sm' id="create-select">创建择货单</a>
</div>
<div class="panel-content">
  <!--left-->
  <div id="panel-list" class='panel-list  choose-active'>
    <div class='panel-title'>
      <p class="left">需求单列表</p>
      <i class='glyphicon glyphicon-chevron-right'></i>
    </div>
    <div class="filter-part">
      <select multiple class="chosen-select" style="width:210px;" data-placeholder="选择筛选条件" id="require-select-outer">
        <%= render partial: 'filters' %>
      </select>
      <a class="btn btn-xs btn-primary active" id="filter-outer"><i class="glyphicon glyphicon-search"></i></a>
    </div>
    <ul id='order-list-panel' class="order-list-panel">
      <%= render partial: 'list' %>
    </ul>
  </div>
  <!--center-->
  <div class="order-content-div">
    <div class="alert" role="alert"><h3>请勾选左侧需求单列表来预览</h3></div>
  </div>
  <!--right-->
  <div id="pick-list-history" class="pick-list-history">
    <div class='panel-title'>
      <i class='glyphicon glyphicon-chevron-left'></i>

      <p class="right">择货单列表</p>
    </div>
    <div id="pick-list">
      <%= render partial: 'picklists' %>
    </div>
  </div>
</div>

<!--Create Picklist Div-->
<div class="outer-scene" id="outer-scene">
  <div class="inner-create">
    <div class="inner-header">
      <h3>创建择货单</h3>
      <i class="glyphicon glyphicon-remove" id="close-scene"></i>
    </div>
    <div class="inner-body">
      <div class="left">
        <div class="filter-part">
          <select multiple class="chosen-select" style="width:310px;" data-placeholder="选择筛选条件" id="require-select-inner">

            <%= render partial: 'filters' %>

          </select>
          <a class="btn btn-xs btn-primary active" id="filter-inner"><i class="glyphicon glyphicon-search"></i></a>
        </div>

        <div class="filter-result">
          <ul id='order-list-panel-inner'>
            <%= render partial: 'list_for_choose' %>
          </ul>
        </div>
      </div>
      <div class="right">
        <input type="button" class="btn btn-primary" value="生成择货单 " onclick="build_pick_list();"/>
      </div>
    </div>
  </div>
</div>
<% content_for :javascript_includes do %>
    <%= javascript_include_tag "panel-manage" %>
<% end %>
<script type="text/javascript">
    $(document).ready(function () {
        chosen.init(["require-select-outer", "require-select-inner"], [210, 310]);
        set_outer_scene();
        $(window).resize(function () {
            set_outer_scene();
        });
        $("body").on("click", "#close-scene", function () {
            $("#outer-scene").css("left", "-999em");
        }).on("click", "#create-select", function () {
            $("#outer-scene").css("left", "0px");
        }).on("click", "#filter-outer", function () {
            var filters = [];
            $("#require-select-outer option:selected").each(function () {
                filters.push($(this).val());
            });

            if (filters.length > 0) {
                $.get('/orders/filt', {filters: filters}, function (data) {
                    $('#order-list-panel').html(data);
                }, 'html');
            } else {
                $.get('/orders/filt', function (data) {
                    $('#order-list-panel').html(data);
                }, 'html');
            }
        }).on("click", "#filter-inner", function () {
            var filters = [];
            $("#require-select-inner option:selected").each(function () {
                filters.push($(this).val());
            });

            if (filters.length > 0) {
                $.get('/orders/filt', {filters: filters}, function (data) {
                    $('#order-list-panel-inner').html(data);
                }, 'html');
            } else {
                $.get('/orders/filt', function (data) {
                    $('#order-list-panel-inner').html(data);
                }, 'html');
            }
        }).on('change','.itemstock-checkbox',function(){
            var id=$(this).val();
            var checked = $(this).attr('checked') == undefined ? false : true;
            $.ajax({
                url:"/order_items/"+id,
                type:"PUT",
                data:{order_item:{out_of_stock:checked}},
                dataType:'json',
                success:function(data){

                }
            });
        }).on('change','.itemfinished-checkbox',function(){
                    var id = $(this).val();
                    var checked = $(this).attr('checked') == undefined ? false : true;
                    $.ajax({
                        url:"/order_items/"+id,
                        type:"PUT",
                        data:{order_item:{is_finished:checked}},
                        dataType:'json',
                        success:function(data){

                        }
                    });
                })
    }).on('click', ".item-a", function () {
        var lists = [];
        $("#panel-list").removeClass("choose-active");
        $("#pick-list-history").addClass("choose-active");
        lists.push($(this).attr("picklist"));
        $.get('/orders/pickitems', {picklist_ids: lists}, function (data) {
            $('.order-content-div').html(data);
        }, 'html');
    })



    function set_outer_scene() {

        var screen_width = document.body.clientWidth,
                screen_height = document.body.clientHeight;
        $("#outer-scene").css({
            width: screen_width,
            height: screen_height
        })
    }
    $('body').on('change', '.order-checkbox', function () {
        $("#panel-list").addClass("choose-active");
        $("#pick-list-history").removeClass("choose-active");
        //get_order_items();
        pm.refresh_orders_items();
    }).on('click', '#change-user-id', function () {
        //get_order_items();
        //pm.refresh_orders_items();
        //pm.get_filters($('#user-id-text').val(), function (data) {
        //   $(".chosen-select").html(data);
        //});
        pm.change_user_id($('#user-id-text').val());

    }).on('change', '#select-all', function () {
        var checked = $(this).attr('checked') == undefined ? false : true;
        if (checked) {
            $(".order-checkbox").prop('checked', true)
        } else {
            $(".order-checkbox").prop('checked', false)
        }
        $(".order-checkbox").eq(0).trigger("change");
    }).on('change', '#select-all-inner', function () {
        var checked = $(this).attr('checked') == undefined ? false : true;
        if (checked) {
            $(".order-checkbox-inner").prop('checked', true)
        } else {
            $(".order-checkbox-inner").prop('checked', false)
        }
        $(".order-checkbox-inner").eq(0).trigger("change");
    }).on("change", ".finishpick-checkbox", function () {
        var order_item_id = $(this).val();
        var is_finished = $(this).attr("checked") == undefined ? false : true;
        console.log(order_item_id);
        $.ajax({
            url: "/order_items/" + order_item_id,
            type: "PUT",
            data: {order_item: {is_finished: is_finished}},
            dataType: 'json',
            success: function (data) {

            }
        });
    }).on("change", ".outofstock-checkbox", function () {
        var order_item_id = $(this).val();
        var out_of_stock = $(this).attr("checked") == undefined ? false : true;
        console.log(order_item_id);
        $.ajax({
            url: "/order_items/" + order_item_id,
            type: "PUT",
            data: {order_item: {out_of_stock: out_of_stock}},
            dataType: 'json',
            success: function (data) {

            }
        });
    })


    function get_order_items() {

    }
    function build_pick_list() {

    }

    function finish_order_handle(handled) {
        var orders = [];
        $('.order-checkbox:checked').each(function () {
            orders.push($(this).val());
        });
        if (orders.length > 0 && confirm('确定完成处理？')) {
            $.post('/orders/handle', {orders: orders, handled: handled}, function (data) {
                if (handled) {
                    $.each(data, function (i, order) {
                        console.log(order);
                        $('#' + order).parent().remove();
                    });
                }
            }, 'json');
        }
    }
    (function refresh_order() {
        setTimeout(function () {
            var orders = [];
            $('.order-checkbox').each(function () {
                orders.push($(this).val());
            });
            $.ajax({
                url: '/orders/panel_list',
                dataType: 'html',
                data: {orders: orders},
                type: 'get',
                success: function (data) {
                    if (data.length > 0) {
                        $('#order-list-panel').append(data);
                    }
                    refresh_order();
                },
                error: function () {
                    refresh_order();
                },
                complete: function (xhr) {
                    if (xhr.status == 304) return;
                }
            });
        }, 30000);
    })();
</script>